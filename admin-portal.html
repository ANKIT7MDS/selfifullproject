<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Event Memory Experience</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üì∏</text></svg>">
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    .toast { position: fixed; right: 1rem; top: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; background: #111827; color: #fff; opacity: 0; transition: opacity .2s ease, transform .2s ease; transform: translateY(-8px); z-index: 50; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #065f46; }
    .toast.error { background: #991b1b; }
    .toast.info { background: #1f2937; }
    .kbd {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 2px 6px; border: 1px solid #e5e7eb; border-bottom-width: 3px; border-radius: .5rem; background:#f9fafb}
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    .badge { padding: .2rem .5rem; border-radius: .5rem; font-size: .75rem; border: 1px solid #e5e7eb; background: #fff; }
    .linklike { text-decoration: underline; color: #111827; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Toast container -->
  <div id="toast-container" class="toast" role="status" aria-live="polite"></div>

  <!-- Root container -->
  <div class="w-full max-w-5xl mx-auto p-4 sm:p-6 lg:p-8" data-admin-root>
    <!-- Header -->
    <header class="flex items-center justify-between pb-4 border-b border-gray-200">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-semibold tracking-tight">‡§á‡§µ‡•á‡§Ç‡§ü ‡§ó‡•à‡§≤‡§∞‡•Ä ‡§è‡§°‡§Æ‡§ø‡§®</h1>
        <span id="regionBadge" class="badge hidden"></span>
        <span id="flowBadge" class="badge hidden"></span>
      </div>
      <div class="flex items-center gap-2">
        <button id="diagBtn" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§°‡§æ‡§Ø‡§ó‡•ç‡§®‡•ã‡§∏‡•ç‡§ü‡§ø‡§ï‡•ç‡§∏</button>
        <button id="logoutBtn" class="hidden px-3 py-2 rounded-xl bg-gray-900 text-white text-sm hover:bg-black">‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü</button>
      </div>
    </header>

    <!-- Master notice -->
    <div id="masterNotice" class="hidden mt-3 text-sm p-3 rounded-2xl border border-amber-300 bg-amber-50 text-amber-900">
      ‡§Ü‡§™ <strong>Master Admin</strong> ‡§π‡•à‡§Ç ‚Äî ‡§Ü‡§™ ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§Æ‡•à‡§®‡•á‡§ú ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
    </div>

    <!-- Diagnostics panel -->
    <details id="diagPanel" class="mt-4">
      <summary class="cursor-pointer text-sm text-gray-600">Self-tests ‡§î‡§∞ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï/‡§ï‡§®‡•ç‡§´‡§º‡§ø‡§ó ‡§°‡§æ‡§Ø‡§ó‡•ç‡§®‡•ã‡§∏‡•ç‡§ü‡§ø‡§ï‡•ç‡§∏</summary>
      <div id="diagOut" class="mt-3 text-sm bg-white rounded-2xl shadow p-4 whitespace-pre-wrap"></div>
      <div class="mt-2 text-xs text-gray-500">‡§®‡•ã‡§ü: ‡§Ö‡§ó‡§∞ ‡§Ü‡§™ <span class="kbd">file://</span> ‡§∏‡•á ‡§ö‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§ï‡•Å‡§õ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Ä‡§Æ‡§æ‡§è‡§Å ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡§Ç‡•§ ‡§¨‡•á‡§π‡§§‡§∞ ‡§π‡•à ‡§ï‡§ø <span class="kbd">http://localhost</span> ‡§™‡§∞ ‡§∏‡§∞‡•ç‡§µ ‡§ï‡§∞‡•á‡§Ç‡•§</div>
    </details>

    <!-- Login Section -->
    <section id="loginSection" class="admin-section active">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-4">‡§≤‡•â‡§ó‡§ø‡§®</h2>
          <div class="grid gap-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤/‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ</label>
            <input id="email" type="text" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com ‡§Ø‡§æ username" />
            <label class="text-sm mt-2">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
            <input id="password" type="password" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <button id="loginBtn" class="mt-4 px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§≤‡•â‡§ó‡§ø‡§®</button>
            <div class="flex items-center gap-3 mt-2">
              <button id="goToSignUp" class="text-sm text-gray-700 underline">‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å</button>
              <button id="goToForgot" class="text-sm linklike">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡•Ç‡§≤ ‡§ó‡§è?</button>
              <button id="hostedUiBtn" class="hidden text-sm linklike">Hosted UI ‡§∏‡•á ‡§≤‡•â‡§ó‡§ø‡§®</button>
            </div>
            <p id="signupDisabledMsg" class="hidden text-xs text-red-600">‡§á‡§∏ User Pool ‡§Æ‡•á‡§Ç self-signup ‡§¨‡§Ç‡§¶ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§∏‡•á ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§µ‡§æ‡§è‡§Å‡•§</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Sign Up Section -->
    <section id="signUpSection" class="admin-section">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-4">‡§∏‡§æ‡§á‡§®-‡§Ö‡§™</h2>
          <div class="grid gap-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤</label>
            <input id="suEmail" type="email" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com" />
            <label class="text-sm mt-2">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
            <input id="suPassword" type="password" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 8 ‡§ï‡•à‡§∞‡•á‡§ï‡•ç‡§ü‡§∞‡•ç‡§∏" />
            <button id="signUpBtn" class="mt-4 px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Å</button>
            <button id="backToLoginFromSignUp" class="mt-2 text-sm text-gray-700 underline">‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Confirm Section -->
    <section id="confirmSection" class="admin-section">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-2">‡§à‡§Æ‡•á‡§≤ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®</h2>
          <p class="text-sm text-gray-600">‡§π‡§Æ‡§®‡•á ‡§Ü‡§™‡§ï‡•á ‡§à‡§Æ‡•á‡§≤ ‡§™‡§∞ ‡§è‡§ï ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡•Ä‡§ö‡•á ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§</p>
          <div class="grid gap-3 mt-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤</label>
            <input id="cfEmail" type="email" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com" />
            <label class="text-sm mt-2">‡§ï‡•ã‡§°</label>
            <input id="cfCode" type="text" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="123456" />
            <div class="flex gap-2 mt-2">
              <button id="confirmBtn" class="px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§ï‡§®‡•ç‡§´‡§º‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç</button>
              <button id="resendBtn" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§ï‡•ã‡§° ‡§´‡§ø‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç</button>
              <button id="backToLoginFromConfirm" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§≤‡•â‡§ó‡§ø‡§®</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Forgot Password Section -->
    <section id="forgotSection" class="admin-section">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-2">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü</h2>
          <div class="grid gap-3 mt-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤/‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ</label>
            <input id="fpEmail" type="text" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com ‡§Ø‡§æ username" />
            <div class="flex gap-2 mt-1">
              <button id="fpSend" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡•á‡§Ç</button>
              <button id="fpBackToLogin" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§≤‡•â‡§ó‡§ø‡§®</button>
            </div>
            <label class="text-sm mt-3">‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡•ã‡§°</label>
            <input id="fpCode" type="text" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="123456" />
            <label class="text-sm mt-2">‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
            <input id="fpNew" type="password" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" />
            <button id="fpConfirm" class="mt-2 px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç</button>
          </div>
        </div>
      </div>
    </section>

    <!-- New Password Required Section (first-time login) -->
    <section id="newPasswordSection" class="admin-section">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-2">‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§≤‡•â‡§ó‡§ø‡§® ‚Äî ‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
          <p class="text-sm text-gray-600">‡§è‡§°‡§Æ‡§ø‡§® ‡§ï‡•á ‡§¨‡§®‡§æ‡§è ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü‡•ç‡§∏ ‡§™‡§∞ ‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§≤‡•â‡§ó‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§∏‡•ç‡§ü‡•á‡§™ ‡§Ü‡§§‡§æ ‡§π‡•à‡•§</p>
          <div class="grid gap-3 mt-3">
            <label class="text-sm">‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
            <input id="npwInput" type="password" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" />
            <div class="flex gap-2 mt-2">
              <button id="npwSubmit" class="px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç</button>
              <button id="npwCancel" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboardSection" class="admin-section">
      <div class="mt-8">
        <div id="masterAdminBar" class="hidden mb-4 flex items-center gap-2">
          <button id="openUserMgmt" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-700">‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü</button>
          <span class="text-xs text-gray-500">(API ‡§∏‡•á‡§ü ‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ø‡§π ‡§°‡•á‡§Æ‡•ã ‡§Æ‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡•á‡§ó‡§æ)</span>
        </div>

        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">‡§á‡§µ‡•á‡§Ç‡§ü‡•ç‡§∏</h2>
          <button id="refreshEvents" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂</button>
        </div>
        <div id="eventList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>
    </section>

    <!-- User Management Section (Master Admin only) -->
    <section id="userMgmtSection" class="admin-section">
      <div class="mt-8 bg-white rounded-2xl shadow p-6">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-lg font-medium">‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü</h2>
            <p class="text-sm text-gray-500 mt-1">‡§Ø‡§π ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•á‡§µ‡§≤ <span class="font-semibold">master-admin</span> ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§ï‡•á ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¶‡•á‡§ñ/‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
          </div>
          <div class="flex gap-2">
            <button id="backFromUserMgmt" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§¨‡•à‡§ï</button>
          </div>
        </div>

        <div id="userApiWarn" class="hidden mt-4 text-sm p-3 rounded-2xl border border-blue-300 bg-blue-50 text-blue-900">
          Admin API ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ URL ‡§Æ‡•á‡§Ç <span class="kbd">?api=&lt;API_BASE_URL&gt;</span> ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§
          ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏:
          <code class="block text-xs mt-2">GET  {api}/users?limit=&nextToken=</code>
          <code class="block text-xs">POST {api}/users               (body: { email, password?, verifyEmail?, groups? })</code>
          <code class="block text-xs">POST {api}/users/{username}/reset-password  (body: { permanent, password? })</code>
          <code class="block text-xs">POST {api}/users/{username}/enable</code>
          <code class="block text-xs">POST {api}/users/{username}/disable</code>
          <code class="block text-xs">DELETE {api}/users/{username}</code>
          <code class="block text-xs">POST {api}/users/{username}/groups (body: { add?: string[], remove?: string[] })</code>
          ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç <span class="kbd">Authorization: &lt;ID_TOKEN&gt;</span> ‡§π‡•á‡§°‡§∞ ‡§≤‡§ó‡•á‡§ó‡§æ‡•§
        </div>

        <div class="mt-4 grid lg:grid-cols-3 gap-6">
          <!-- Create user card -->
          <div class="lg:col-span-1 bg-gray-50 rounded-2xl p-4 border border-gray-200">
            <h3 class="font-semibold mb-2">‡§®‡§Ø‡§æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¨‡§®‡§æ‡§è‡§Å</h3>
            <label class="text-xs">‡§à‡§Æ‡•á‡§≤</label>
            <input id="umEmail" type="email" class="w-full mb-2 px-3 py-2 rounded-xl border border-gray-300" placeholder="user@example.com" />
            <label class="text-xs">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‚Äî ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º‡•á‡§Ç ‡§§‡•ã ‡§ü‡•á‡§Æ‡•ç‡§™ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°)</label>
            <input id="umPassword" type="password" class="w-full mb-2 px-3 py-2 rounded-xl border border-gray-300" />
            <label class="text-xs">‡§ó‡•ç‡§∞‡•Å‡§™‡•ç‡§∏ (comma ‡§∏‡•á‡§™‡§∞‡•á‡§ü‡•á‡§°, ‡§â‡§¶‡§æ. master-admin, client)</label>
            <input id="umGroups" type="text" class="w-full mb-3 px-3 py-2 rounded-xl border border-gray-300" />
            <div class="flex items-center gap-2 mb-3">
              <input id="umVerifyEmail" type="checkbox" class="h-4 w-4" />
              <span class="text-xs">‡§à‡§Æ‡•á‡§≤ verified ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç</span>
            </div>
            <button id="umCreateBtn" class="px-3 py-2 rounded-xl bg-gray-900 text-white text-sm hover:bg-black">‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¨‡§®‡§æ‡§è‡§Å</button>
          </div>

          <!-- Users table -->
          <div class="lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü</h3>
              <div class="flex gap-2">
                <input id="umSearch" type="text" class="px-3 py-2 rounded-xl border border-gray-300 text-sm" placeholder="‡§à‡§Æ‡•á‡§≤ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç" />
                <button id="umRefresh" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂</button>
              </div>
            </div>
            <div class="overflow-auto border border-gray-200 rounded-2xl">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left px-3 py-2">Username</th>
                    <th class="text-left px-3 py-2">Email</th>
                    <th class="text-left px-3 py-2">Status</th>
                    <th class="text-left px-3 py-2">Groups</th>
                    <th class="text-left px-3 py-2">Actions</th>
                  </tr>
                </thead>
                <tbody id="umTbody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
            <div class="flex justify-end mt-2">
              <button id="umNext" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm hidden">‡§Ö‡§ó‡§≤‡§æ ‡§™‡•á‡§ú</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Upload Section -->
    <section id="uploadSection" class="admin-section">
      <div class="mt-8 bg-white rounded-2xl shadow p-6">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-lg font-medium">‡§´‡§º‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°</h2>
            <p id="uploadTitle" class="text-sm text-gray-500 mt-1">‡§ï‡§ø‡§∏‡•Ä ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§º‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç</p>
          </div>
          <button id="backToDashboard" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§¨‡•à‡§ï</button>
        </div>
        <div class="mt-4 grid gap-3">
          <!-- MODIFICATION: Removed accept="image/*" to allow all file types -->
          <input id="fileInput" type="file" multiple class="block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gray-900 file:text-white hover:file:bg-black" />
          <button id="startUpload" class="px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black disabled:opacity-50" disabled>‡§Ö‡§™‡§≤‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
          <div id="uploadStatus" class="text-sm text-gray-600"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Multi-CDN Amplify loader + App -->
  <script>
    (function(){
      // ===== Config (editable) =====
      const DEFAULT_COGNITO = {
        REGION: 'ap-southeast-1',
        USER_POOL_ID: 'ap-southeast-1_YGZSUnSf5',
        USER_POOL_WEB_CLIENT_ID: '1mecg9v8gfau80k08arpofgl4l'
      };
      // Feature flags
      const FEATURES = {
        allowSignUp: false,
        allowHostedUI: false
      };

      const qp = new URLSearchParams(location.search);
      const COGNITO = {
        REGION: qp.get('region') || DEFAULT_COGNITO.REGION,
        USER_POOL_ID: qp.get('userPoolId') || DEFAULT_COGNITO.USER_POOL_ID,
        USER_POOL_WEB_CLIENT_ID: qp.get('clientId') || DEFAULT_COGNITO.USER_POOL_WEB_CLIENT_ID,
      };
      if (qp.has('signup')) FEATURES.allowSignUp = qp.get('signup') === '1';
      const HOSTED_UI_DOMAIN = qp.get('domain') || '';
      if (HOSTED_UI_DOMAIN) FEATURES.allowHostedUI = true;
      const API_BASE = qp.get('api') || '';

      const inferredRegion = (COGNITO.USER_POOL_ID.match(/^([a-z]{2}-[a-z-]+-\d+)_/i) || [null, null])[1];
      if (inferredRegion && inferredRegion !== COGNITO.REGION) {
        console.warn('[Amplify] Region mismatch: config', COGNITO.REGION, 'vs inferred', inferredRegion, '‚Üí using inferred');
        COGNITO.REGION = inferredRegion;
      }

      const regionBadge = document.getElementById('regionBadge');
      regionBadge.textContent = `Region: ${COGNITO.REGION}`; regionBadge.classList.remove('hidden');
      const flowBadge = document.getElementById('flowBadge');

      function showToast(msg, type = 'info', ms = 3500) {
        const el = document.getElementById('toast-container');
        if (!el) return;
        el.className = 'toast ' + type;
        el.textContent = msg;
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => el.classList.remove('show'), ms);
      }
      const isFileProto = location.protocol === 'file:';

      const sectionIds = ['loginSection', 'signUpSection', 'confirmSection', 'forgotSection', 'newPasswordSection', 'dashboardSection', 'userMgmtSection', 'uploadSection'];
      function showSection(el) { sectionIds.forEach(id => document.getElementById(id).classList.remove('active')); el.classList.add('active'); }

      // DOM nodes (shortened for brevity)
      const loginSection = document.getElementById('loginSection');
      const dashboardSection = document.getElementById('dashboardSection');
      const signUpSection = document.getElementById('signUpSection');
      const confirmSection = document.getElementById('confirmSection');
      const forgotSection = document.getElementById('forgotSection');
      const newPasswordSection = document.getElementById('newPasswordSection');
      const uploadSection = document.getElementById('uploadSection');
      const userMgmtSection = document.getElementById('userMgmtSection');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const loginBtn = document.getElementById('loginBtn');
      const goToSignUp = document.getElementById('goToSignUp');
      const goToForgot = document.getElementById('goToForgot');
      const hostedUiBtn = document.getElementById('hostedUiBtn');
      const suEmail = document.getElementById('suEmail');
      const suPassword = document.getElementById('suPassword');
      const signUpBtn = document.getElementById('signUpBtn');
      const backToLoginFromSignUp = document.getElementById('backToLoginFromSignUp');
      const cfEmail = document.getElementById('cfEmail');
      const cfCode = document.getElementById('cfCode');
      const confirmBtn = document.getElementById('confirmBtn');
      const resendBtn = document.getElementById('resendBtn');
      const backToLoginFromConfirm = document.getElementById('backToLoginFromConfirm');
      const fpEmail = document.getElementById('fpEmail');
      const fpCode = document.getElementById('fpCode');
      const fpNew = document.getElementById('fpNew');
      const fpSend = document.getElementById('fpSend');
      const fpConfirm = document.getElementById('fpConfirm');
      const fpBackToLogin = document.getElementById('fpBackToLogin');
      const logoutBtn = document.getElementById('logoutBtn');
      const diagBtn = document.getElementById('diagBtn');
      const diagOut = document.getElementById('diagOut');
      const eventList = document.getElementById('eventList');
      const refreshEvents = document.getElementById('refreshEvents');
      const backToDashboard = document.getElementById('backToDashboard');
      const fileInput = document.getElementById('fileInput');
      const startUpload = document.getElementById('startUpload');
      const uploadTitle = document.getElementById('uploadTitle');
      const uploadStatus = document.getElementById('uploadStatus');
      const signupDisabledMsg = document.getElementById('signupDisabledMsg');
      const masterAdminBar = document.getElementById('masterAdminBar');
      const masterNotice = document.getElementById('masterNotice');
      const openUserMgmt = document.getElementById('openUserMgmt');
      const backFromUserMgmt = document.getElementById('backFromUserMgmt');
      const userApiWarn = document.getElementById('userApiWarn');
      const umEmail = document.getElementById('umEmail');
      const umPassword = document.getElementById('umPassword');
      const umGroups = document.getElementById('umGroups');
      const umVerifyEmail = document.getElementById('umVerifyEmail');
      const umCreateBtn = document.getElementById('umCreateBtn');
      const umRefresh = document.getElementById('umRefresh');
      const umNext = document.getElementById('umNext');
      const umTbody = document.getElementById('umTbody');
      const umSearch = document.getElementById('umSearch');

      function updateSignUpVisibility(){
        if (FEATURES.allowSignUp){
          goToSignUp.classList.remove('hidden'); signupDisabledMsg.classList.add('hidden');
        } else {
          goToSignUp.classList.add('hidden'); signupDisabledMsg.classList.remove('hidden');
          if (signUpSection.classList.contains('active')) showSection(loginSection);
        }
        hostedUiBtn.classList.toggle('hidden', !FEATURES.allowHostedUI);
      }

      [emailInput, passwordInput].forEach(inp => inp && inp.addEventListener('keydown', e => { if (e.key === 'Enter') loginBtn.click(); }));

      // ===== Amplify Loader =====
      // Using a simplified loader for clarity
      async function ensureAmplify() {
        if (window.aws_amplify) return;
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/aws-amplify/dist/aws-amplify.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      function resolveAmplify(){ const ns = window.aws_amplify; return { Amplify: ns.Amplify, Auth: ns.Auth, Storage: ns.Storage }; }

      // ===== App Logic =====
      let AUTH_FLOW = (qp.get('authflow') === 'password') ? 'USER_PASSWORD_AUTH' : 'USER_SRP_AUTH';
      async function configureAmplify(){
        const { Amplify } = resolveAmplify(); if (!Amplify?.configure) throw new Error('Amplify.configure not available');
        Amplify.configure({ Auth: { region: COGNITO.REGION, userPoolId: COGNITO.USER_POOL_ID, userPoolWebClientId: COGNITO.USER_POOL_WEB_CLIENT_ID, authenticationFlowType: AUTH_FLOW } });
        flowBadge.textContent = `AuthFlow: ${AUTH_FLOW}`; flowBadge.classList.remove('hidden');
      }
      async function checkUserSession(){
        const { Auth } = resolveAmplify();
        try{
          const user = await Auth.currentAuthenticatedUser();
          if (user){
            logoutBtn.classList.remove('hidden');
            const session = await Auth.currentSession();
            const idToken = session.getIdToken().getJwtToken();
            const payload = JSON.parse(atob(idToken.split('.')[1] || 'e30='));
            const groups = payload['cognito:groups'] || [];
            const isMaster = Array.isArray(groups) && groups.includes('master-admin');
            window.__id_token = idToken; window.__is_master = isMaster;
            if (isMaster){ masterAdminBar.classList.remove('hidden'); masterNotice.classList.remove('hidden'); }
            showSection(dashboardSection); await loadEvents();
          } else { showSection(loginSection); }
        } catch{ showSection(loginSection); }
      }

      function preValidateLogin(){
        const u = (emailInput.value || '').trim(); const p = passwordInput.value;
        if (!u || !p){ showToast('‡§à‡§Æ‡•á‡§≤/‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return false; }
        return true;
      }

      function mapAuthError(error){
        const name = error?.name || 'Error'; const raw = error?.message || '';
        const map = { UserNotFoundException: '‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ', NotAuthorizedException: '‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Ø‡§æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø', UserNotConfirmedException: '‡§à‡§Æ‡•á‡§≤ ‡§µ‡•á‡§∞‡§ø‡§´‡§º‡§ø‡§ï‡•á‡§∂‡§® ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó', PasswordResetRequiredException: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', };
        let hint = map[name] || raw || '‡§≤‡•â‡§ó‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
        if (/SRP|Password verifier failed/i.test(raw) && AUTH_FLOW === 'USER_SRP_AUTH') hint += ' ‚Äî URL ‡§Æ‡•á‡§Ç ?authflow=password ‡§ü‡•ç‡§∞‡§æ‡§Ø ‡§ï‡§∞‡•á‡§Ç';
        return { name, hint };
      }

      let pendingChallengeUser = null;
      async function doLogin(){
        const { Auth } = resolveAmplify();
        if (!preValidateLogin()) return;
        const username = (emailInput.value || '').trim(); const password = passwordInput.value;
        loginBtn.disabled = true;
        try{
          const res = await Auth.signIn(username, password);
          if (res?.challengeName === 'NEW_PASSWORD_REQUIRED'){
            pendingChallengeUser = res; showSection(newPasswordSection); showToast('‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§≤‡•â‡§ó‡§ø‡§® ‚Äî ‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç', 'info', 6000); return;
          }
          showToast('‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§´‡§≤', 'success'); logoutBtn.classList.remove('hidden');
          emailInput.value=''; passwordInput.value='';
          showSection(dashboardSection); await loadEvents();
        } catch(error){
          console.error('SignIn error', error);
          let { name, hint } = mapAuthError(error);
          if (/SRP|Password verifier failed/i.test(error?.message||'') && AUTH_FLOW === 'USER_SRP_AUTH'){
            try{
              AUTH_FLOW = 'USER_PASSWORD_AUTH'; await configureAmplify();
              const res2 = await Auth.signIn(username, password);
              if (res2?.challengeName === 'NEW_PASSWORD_REQUIRED'){ pendingChallengeUser = res2; showSection(newPasswordSection); showToast('‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§≤‡•â‡§ó‡§ø‡§® ‚Äî ‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°', 'info'); return; }
              showToast('‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§´‡§≤ (PASSWORD flow)', 'success'); flowBadge.textContent = `AuthFlow: ${AUTH_FLOW}`;
              logoutBtn.classList.remove('hidden'); showSection(dashboardSection); await loadEvents(); return;
            }catch(e2){ console.error('Fallback login failed', e2); const m = mapAuthError(e2); name = m.name; hint = m.hint; }
          }
          showToast(`${name}: ${hint}`, 'error', 7000);
          if (name==='UserNotConfirmedException'){ cfEmail.value=username; showSection(confirmSection); }
        } finally { loginBtn.disabled = false; }
      }

      async function doSignUp(){ const { Auth } = resolveAmplify(); const email = suEmail.value.trim(); const pwd = suPassword.value; if(!email||!pwd){ showToast('‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; } if(!FEATURES.allowSignUp){ showToast('‡§á‡§∏ ‡§™‡•Ç‡§≤ ‡§Æ‡•á‡§Ç self-signup ‡§¨‡§Ç‡§¶ ‡§π‡•à', 'error', 5000); return; } signUpBtn.disabled=true; try{ await Auth.signUp({ username: email, password: pwd, attributes:{ email } }); showToast('‡§∏‡§æ‡§á‡§®-‡§Ö‡§™ ‡§∏‡§´‡§≤ ‚Äî ‡§à‡§Æ‡•á‡§≤ ‡§™‡§∞ ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ', 'success', 5000); cfEmail.value=email; showSection(confirmSection);} catch(e){ console.error('SignUp error', e); if (e?.name==='NotAuthorizedException' && /SignUp is not permitted/i.test(e?.message||'')){ FEATURES.allowSignUp=false; updateSignUpVisibility(); showToast('Self-signup ‡§á‡§∏ User Pool ‡§Æ‡•á‡§Ç disabled ‡§π‡•à', 'error', 6000); showSection(loginSection); } else { showToast(e?.message || '‡§∏‡§æ‡§á‡§®-‡§Ö‡§™ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } } finally{ signUpBtn.disabled=false; } }
      async function doConfirm(){ const { Auth } = resolveAmplify(); const email=(cfEmail.value||'').trim(); const code=(cfCode.value||'').trim(); if(!email||!code){ showToast('‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§ï‡•ã‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; } confirmBtn.disabled=true; try{ await Auth.confirmSignUp(email, code); showToast('‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§∏‡§´‡§≤ ‚Äî ‡§Ö‡§¨ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç', 'success'); emailInput.value=email; showSection(loginSection);} catch(e){ console.error('Confirm error', e); showToast(e?.message || '‡§ï‡§®‡•ç‡§´‡§º‡§∞‡•ç‡§Æ‡•á‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } finally{ confirmBtn.disabled=false; } }
      async function doForgotStart(){ const { Auth } = resolveAmplify(); const u=(fpEmail.value||'').trim(); if(!u){ showToast('‡§à‡§Æ‡•á‡§≤/‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ ‡§≠‡§∞‡•á‡§Ç', 'error'); return; } try{ await Auth.forgotPassword(u); showToast('‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ', 'success'); } catch(e){ console.error('Forgot start error', e); showToast(e?.message || '‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } }
      async function doForgotConfirm(){ const { Auth } = resolveAmplify(); const u=(fpEmail.value||'').trim(); const code=(fpCode.value||'').trim(); const np=(fpNew.value||''); if(!u||!code||!np){ showToast('‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; } try{ await Auth.forgotPasswordSubmit(u, code, np); showToast('‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤ ‡§ó‡§Ø‡§æ ‚Äî ‡§Ö‡§¨ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç', 'success'); emailInput.value=u; showSection(loginSection); } catch(e){ console.error('Forgot submit error', e); showToast(e?.message || '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } }
      async function doResend(){ const { Auth } = resolveAmplify(); const email=(cfEmail.value||'').trim(); if(!email){ showToast('‡§à‡§Æ‡•á‡§≤ ‡§≠‡§∞‡•á‡§Ç', 'error'); return; } try{ await Auth.resendSignUp(email); showToast('‡§ï‡•ã‡§° ‡§™‡•Å‡§®‡§É ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ', 'success'); } catch(e){ console.error('Resend error', e); showToast(e?.message || '‡§∞‡•Ä-‡§∏‡•á‡§Ç‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } }
      async function doLogout(){ const { Auth } = resolveAmplify(); try{ await Auth.signOut(); }catch{} showToast('‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 'info'); logoutBtn.classList.add('hidden'); masterAdminBar.classList.add('hidden'); masterNotice.classList.add('hidden'); showSection(loginSection); }
      
      async function loadEvents(){ const items=[{id:'evt_1',name:'Diwali Night 2024',photos:0},{id:'evt_2',name:'Wedding - A&V',photos:120},{id:'evt_3',name:'Corporate Meetup',photos:58}]; renderEvents(items); }
      function renderEvents(items){ eventList.innerHTML=''; if(!items||!items.length){ eventList.innerHTML='<div class="text-sm text-gray-600">‡§ï‡•ã‡§à ‡§á‡§µ‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</div>'; return; } for(const it of items){ const card=document.createElement('div'); card.className='bg-white rounded-2xl shadow p-5 flex flex-col gap-3'; card.innerHTML=`<div class="flex-1"><div class="text-base font-semibold">${it.name}</div><div class="text-sm text-gray-500 mt-1">‡§´‡§º‡•ã‡§ü‡•ã: ${it.photos}</div></div><div class="flex gap-2"><button class="upload-btn px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black text-sm" data-event-id="${it.id}" data-event-name="${it.name}">‡§´‡§º‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°</button><button class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm" disabled>‡§Æ‡•à‡§®‡•á‡§ú</button></div>`; eventList.appendChild(card);} }

      eventList.addEventListener('click', (e)=>{ const btn=e.target.closest('.upload-btn'); if(!btn) return; const eventName=btn.dataset.eventName; const eventId=btn.dataset.eventId; uploadTitle.textContent=`"${eventName}" ‡§Æ‡•á‡§Ç ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç`; uploadSection.dataset.eventId = eventId; uploadSection.dataset.eventName = eventName; showSection(uploadSection); });
      fileInput.addEventListener('change', ()=>{ startUpload.disabled=!(fileInput.files&&fileInput.files.length); uploadStatus.textContent=''; });

      // MODIFICATION: Log file details to console instead of a fake upload
      async function uploadFilesForEvent(eventId, eventName){
        if (!fileInput.files?.length) return;
        const files = Array.from(fileInput.files);
        console.log(`Preparing to "upload" ${files.length} files for event: ${eventName} (${eventId})`);
        
        let uploaded = 0;
        startUpload.disabled = true;

        for (const file of files) {
          try {
            // In a real app, this is where you'd call a function to upload to S3
            // For now, we just log the details to the console.
            console.log('File details:', file);
            
            // Simulate upload delay
            await new Promise(r => setTimeout(r, 300));
            uploaded++;
            uploadStatus.textContent = `${uploaded}/${files.length} ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ... (‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç)`;
          } catch (e) {
            console.error('Simulated upload failed for file:', file.name, e);
            showToast(`'${file.name}' ‡§ï‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤`, 'error');
            break; // Stop on first error
          }
        }
        
        if (uploaded === files.length) {
          showToast('‡§∏‡§≠‡•Ä ‡§´‡§º‡§æ‡§á‡§≤‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à', 'success');
          fileInput.value = '';
        }
        startUpload.disabled = false;
      }
      
      function authzHeaders(){ return { 'Authorization': window.__id_token }; }
      async function loadUsers(nextToken=null){
        umTbody.innerHTML = '';
        if (!API_BASE){
          umTbody.innerHTML = `<tr><td class="px-3 py-2">demo-user</td><td class="px-3 py-2">demo@example.com</td><td class="px-3 py-2">CONFIRMED</td><td class="px-3 py-2">client</td><td class="px-3 py-2 text-xs text-gray-500">(‡§°‡•á‡§Æ‡•ã)</td></tr>`;
          umNext.classList.add('hidden'); return;
        }
        try{
          const q = new URLSearchParams({ limit: '25' });
          if (nextToken) q.set('nextToken', nextToken);
          const search = (umSearch.value||'').trim();
          if (search) q.set('filter', `email ^= "${search}"`);
          const r = await fetch(`${API_BASE.replace(/\/$/, '')}/users?${q}`, { headers: authzHeaders() });
          if (!r.ok) throw new Error(`List users failed: ${r.status}`);
          const data = await r.json();
          (data.users||[]).forEach(u=> addUserRow(u));
          if (data.nextToken){ window.__um_next_token = data.nextToken; umNext.classList.remove('hidden'); } else { umNext.classList.add('hidden'); }
        } catch(e){ console.error(e); showToast(e.message || '‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); }
      }
      function addUserRow(u){
        const tr = document.createElement('tr');
        const email = (u.Attributes||[]).find(a=>a.Name==='email')?.Value || '-';
        const username = u.Username || '-';
        const status = u.UserStatus || '-';
        const groups = (u.Groups||[]).map(g=>g.GroupName).join(', ');
        tr.innerHTML = `<td class="px-3 py-2">${username}</td><td class="px-3 py-2">${email}</td><td class="px-3 py-2">${status}</td><td class="px-3 py-2">${groups||'-'}</td>
          <td class="px-3 py-2 flex gap-1">
            <button class="um-reset border px-2 py-1 rounded-lg text-xs hover:bg-gray-100">Reset PW</button>
            <button class="um-disable border px-2 py-1 rounded-lg text-xs hover:bg-gray-100">Disable</button>
            <button class="um-enable border px-2 py-1 rounded-lg text-xs hover:bg-gray-100">Enable</button>
            <button class="um-delete border px-2 py-1 rounded-lg text-xs text-red-600 hover:bg-red-50">Delete</button>
          </td>`;
        tr.dataset.username = username;
        umTbody.appendChild(tr);
      }
      async function createUserFromForm(){
        if (!API_BASE){ showToast('Admin API ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (?api=...)', 'error'); return; }
        const email = (umEmail.value||'').trim();
        if (!email){ showToast('‡§à‡§Æ‡•á‡§≤ ‡§≠‡§∞‡•á‡§Ç', 'error'); return; }
        const body = { email, verifyEmail: !!umVerifyEmail.checked };
        if ((umPassword.value||'').length) body.password = umPassword.value;
        const groups = (umGroups.value||'').split(',').map(s=>s.trim()).filter(Boolean);
        if (groups.length) body.groups = groups;
        try{
          const r = await fetch(`${API_BASE.replace(/\/$/, '')}/users`, { method:'POST', headers: { 'Content-Type': 'application/json', ...authzHeaders() }, body: JSON.stringify(body) });
          if (!r.ok) throw new Error(`Create failed: ${await r.text()}`);
          showToast('‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§¨‡§®‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 'success'); umEmail.value=''; umPassword.value=''; umGroups.value=''; umVerifyEmail.checked=false; loadUsers();
        }catch(e){ console.error(e); showToast(e.message || '‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ç‡§∞‡§ø‡§è‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); }
      }
      umTbody.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr'); if (!tr || !API_BASE) return;
        const username = tr.dataset.username; if (!username) return;
        const base = `${API_BASE.replace(/\/$/, '')}/users/${encodeURIComponent(username)}`;
        async function call(path, method='POST', body){
          const r = await fetch(`${base}${path}`, { method, headers: { 'Content-Type': 'application/json', ...authzHeaders() }, body: body? JSON.stringify(body): undefined });
          if (!r.ok) throw new Error(`${path} failed: ${await r.text()}`); return r.json().catch(()=>({}));
        }
        try{
          if (e.target.matches('.um-reset')){ const permanent = confirm('Permanent ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç? OK=Permanent / Cancel=Temp'); let password=null; if (permanent){ password = prompt('‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç'); if (!password) return; } await call('/reset-password','POST', { permanent, password }); showToast('‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•Å‡§Ü', 'success'); }
          if (e.target.matches('.um-disable')){ await call('/disable'); showToast('‡§Ø‡•Ç‡§ú‡§º‡§∞ disabled', 'success'); loadUsers(); }
          if (e.target.matches('.um-enable')){ await call('/enable'); showToast('‡§Ø‡•Ç‡§ú‡§º‡§∞ enabled', 'success'); loadUsers(); }
          if (e.target.matches('.um-delete')){ if (!confirm('‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç?')) return; await call('','DELETE'); showToast('‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§°‡§ø‡§≤‡•Ä‡§ü', 'success'); tr.remove(); }
        } catch(err){ console.error(err); showToast(err.message || '‡§è‡§ï‡•ç‡§∂‡§® ‡§µ‡§ø‡§´‡§≤', 'error'); }
      });

      // Event listeners
      loginBtn.addEventListener('click', doLogin);
      goToSignUp.addEventListener('click', ()=> showSection(signUpSection));
      goToForgot.addEventListener('click', ()=> { fpEmail.value = emailInput.value; showSection(forgotSection); });
      signUpBtn.addEventListener('click', doSignUp);
      backToLoginFromSignUp.addEventListener('click', ()=> showSection(loginSection));
      confirmBtn.addEventListener('click', doConfirm);
      resendBtn.addEventListener('click', doResend);
      backToLoginFromConfirm.addEventListener('click', ()=> showSection(loginSection));
      fpSend.addEventListener('click', doForgotStart);
      fpConfirm.addEventListener('click', doForgotConfirm);
      fpBackToLogin.addEventListener('click', ()=> showSection(loginSection));
      logoutBtn.addEventListener('click', doLogout);
      refreshEvents.addEventListener('click', loadEvents);
      backToDashboard.addEventListener('click', ()=> showSection(dashboardSection));
      openUserMgmt.addEventListener('click', ()=> { if (!window.__is_master){ showToast('Master admin ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', 'error'); return; } showSection(userMgmtSection); if(!API_BASE){ userApiWarn.classList.remove('hidden'); } loadUsers(); });
      backFromUserMgmt.addEventListener('click', ()=> showSection(dashboardSection));
      umRefresh.addEventListener('click', ()=> loadUsers());
      umNext.addEventListener('click', ()=> loadUsers(window.__um_next_token||null));
      umCreateBtn.addEventListener('click', createUserFromForm);
      startUpload.addEventListener('click', async()=>{ const eventId = uploadSection.dataset.eventId; const eventName = uploadSection.dataset.eventName; if(!eventId){ showToast('‡§á‡§µ‡•á‡§Ç‡§ü ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç', 'error'); return; } await uploadFilesForEvent(eventId, eventName); });
      diagBtn.addEventListener('click', runDiagnostics);

      const npwInput = document.getElementById('npwInput');
      const npwSubmit = document.getElementById('npwSubmit');
      const npwCancel = document.getElementById('npwCancel');
      npwSubmit.addEventListener('click', async ()=>{
        const { Auth } = resolveAmplify();
        const npw = npwInput.value || '';
        if (!pendingChallengeUser){ showToast('‡§ï‡•ã‡§à ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§∏‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç', 'error'); return; }
        if (!npw){ showToast('‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; }
        try { const done = await Auth.completeNewPassword(pendingChallengeUser, npw); pendingChallengeUser = null; npwInput.value=''; showToast('‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡•á‡§ü ‚Äî ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•Ç‡§∞‡§æ', 'success'); logoutBtn.classList.remove('hidden'); showSection(dashboardSection); await loadEvents(); console.debug('CompleteNewPassword:', done); }
        catch(e){ console.error('CompleteNewPassword error', e); showToast(e?.message || '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); }
      });
      npwCancel.addEventListener('click', ()=>{ pendingChallengeUser = null; npwInput.value=''; showSection(loginSection); });

      // Boot
      (async function boot(){
        try{
          if(isFileProto) showToast('‡§¨‡•á‡§π‡§§‡§∞ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§π‡•á‡§§‡•Å localhost ‡§∏‡•á ‡§ö‡§≤‡§æ‡§è‡§Å', 'info', 4500);
          updateSignUpVisibility();
          showToast('Amplify ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶', 'info');
          await ensureAmplify();
          const { Amplify, Auth } = resolveAmplify(); if(!Amplify||!Auth) throw new Error('Amplify globals missing after load');
          await configureAmplify(); showToast('Amplify ‡§§‡•à‡§Ø‡§æ‡§∞', 'success');
          await checkUserSession();
        } catch(e){
          console.error(e);
          showToast('Amplify ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‚Äî ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï/CDN ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç', 'error');
          showSection(loginSection);
        }
      })();

      // ===== Self-tests =====
      function logDiag(line){ diagOut.textContent += (line + '\n'); }
      function clearDiag(){ diagOut.textContent = ''; }
      function assertTest(name, cond){ logDiag(`${cond ? '‚úÖ' : '‚ùå'} ${name}`); return !!cond; }
      async function runDiagnostics(){
        clearDiag(); logDiag('‚Äî ‡§∞‡§®‡§ø‡§Ç‡§ó Self-tests ‚Äî'); logDiag(`URL: ${location.href}`); logDiag(`Protocol: ${location.protocol}`);
        logDiag('Config (final):'); logDiag('  REGION=' + COGNITO.REGION); logDiag('  USER_POOL_ID=' + COGNITO.USER_POOL_ID); logDiag('  CLIENT_ID=' + COGNITO.USER_POOL_WEB_CLIENT_ID); logDiag('  Inferred from pool=' + (inferredRegion || 'n/a')); logDiag('  Expected Cognito endpoint: https://cognito-idp.'+COGNITO.REGION+'.amazonaws.com'); logDiag('  allowSignUp=' + FEATURES.allowSignUp + ', allowHostedUI=' + FEATURES.allowHostedUI + ', authFlow=' + AUTH_FLOW);
        
        let ampNS = window.aws_amplify || window.Amplify;
        assertTest('Amplify namespace detected', !!ampNS);
        const { Amplify, Auth } = resolveAmplify(); 
        assertTest('Amplify.configure ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', !!Amplify?.configure); 
        assertTest('Auth.signIn ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', typeof Auth?.signIn === 'function');
        
        try { const jwksUrl = `https://cognito-idp.${COGNITO.REGION}.amazonaws.com/${COGNITO.USER_POOL_ID}/.well-known/jwks.json`; const r = await fetch(jwksUrl, { method:'GET' }); logDiag('JWKS fetch status: ' + r.status); } catch(e){ logDiag('JW_KS fetch error: ' + (e?.message||e)); }
        logDiag('‚Äî Self-tests complete ‚Äî');
        document.getElementById('diagPanel').open = true;
      }
    })();
  </script>
</body>
</html>
