<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>फेस से फोटो खोजें (लाइव)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-color: #2563eb; --brand-color-hover: #1d4ed8; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .container { max-width: 800px; width: 100%; transition: all 0.5s ease-in-out; }
        .step-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        @media (min-width: 768px) { .step-card { padding: 2rem; } }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; border: none; }
        .btn-primary { background-color: var(--brand-color); color: white; box-shadow: 0 4px 14px 0 rgb(0 118 255 / 39%); }
        .btn-primary:hover { background-color: var(--brand-color-hover); transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgb(0 118 255 / 23%); }
        .loader-container .loader { border: 4px solid #4b5563; border-top: 4px solid var(--brand-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-wrapper { position: relative; }
        .input-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; }
        .input-field { padding-left: 2.5rem !important; }
        .image-result-item { position: relative; overflow: hidden; border-radius: 0.5rem; }
        .download-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); transform: translateY(100%); transition: transform 0.3s ease; }
        .image-result-item:hover .download-overlay { transform: translateY(0); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    
    <header class="w-full max-w-5xl mx-auto py-4">
        <h2 class="text-2xl font-bold text-gray-300 text-center sm:text-left">[ग्राहक का लोगो यहाँ]</h2>
    </header>

    <main class="flex-grow flex items-center justify-center w-full">
        <div class="container text-center">
            <!-- Main Content Area -->
            <div id="main-content" class="fade-in">
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-3">अपनी यादगार तस्वीरें खोजें</h1>
                <p class="text-gray-400 mb-8 max-w-2xl mx-auto">बस अपना विवरण दर्ज करें और अपना चेहरा स्कैन करें। हमारा AI बाकी काम कर देगा।</p>

                <!-- Step 1: User Details -->
                <div class="step-card text-left">
                    <h3 class="text-xl font-semibold mb-4">चरण 1: अपना विवरण दर्ज करें</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-wrapper">
                            <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></span>
                            <input type="text" id="user-name" placeholder="पूरा नाम" class="w-full bg-gray-800 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 input-field">
                            <p id="name-error" class="text-red-400 text-sm mt-1 hidden">कृपया अपना नाम दर्ज करें।</p>
                        </div>
                        <div class="input-wrapper">
                           <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg></span>
                            <input type="tel" id="user-mobile" placeholder="मोबाइल नंबर (10 अंक)" maxlength="10" class="w-full bg-gray-800 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 input-field">
                            <p id="mobile-error" class="text-red-400 text-sm mt-1 hidden">कृपया मान्य 10 अंकों का नंबर दर्ज करें।</p>
                        </div>
                    </div>
                     <div class="mt-4 input-wrapper">
                        <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg></span>
                        <input type="email" id="user-email" placeholder="ईमेल" class="w-full bg-gray-800 border border-gray-600 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 input-field">
                        <p id="email-error" class="text-red-400 text-sm mt-1 hidden">कृपया मान्य ईमेल दर्ज करें।</p>
                    </div>
                </div>

                <!-- Step 2: Provide Photo -->
                <div class="step-card">
                    <h3 class="text-xl font-semibold mb-4 text-left">चरण 2: अपनी तस्वीर प्रदान करें</h3>
                    <div id="camera-container">
                        <video id="camera-feed" width="640" height="480" autoplay playsinline class="mx-auto w-full max-w-lg rounded-lg hidden"></video>
                        <canvas id="snapshot-canvas" class="hidden w-full max-w-lg mx-auto rounded-lg"></canvas>
                         <div id="upload-placeholder" class="border-2 border-dashed border-gray-600 rounded-lg p-8 flex flex-col items-center justify-center">
                            <svg class="w-12 h-12 text-gray-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <p class="text-gray-400">कैमरा शुरू करें या अपनी फाइल अपलोड करें</p>
                        </div>
                        <div id="controls" class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
                            <button id="start-camera" class="btn btn-secondary w-full sm:w-auto"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 4.372A1 1 0 0116 5.175V15a1 1 0 01-1.447.894l-4-3A1 1 0 0110 12V8a1 1 0 01.553-.894l4-3z" /></svg><span>कैमरा शुरू करें</span></button>
                            <span class="text-sm text-gray-500">या</span>
                            <label for="upload-file" class="btn btn-secondary w-full sm:w-auto cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span>फाइल अपलोड करें</span></label>
                            <input type="file" id="upload-file" accept="image/*" class="hidden"/>
                        </div>
                        <div id="live-controls" class="hidden mt-4 flex items-center justify-center gap-4">
                            <button id="snap-photo" class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm10 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg><span>फोटो खींचें</span></button>
                            <button id="retry-photo" class="btn btn-secondary">पुनः प्रयास करें</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loader State -->
            <div id="loader-container" class="hidden text-center p-8 fade-in">
                <div class="loader mx-auto"></div>
                <p id="loader-text" class="mt-4 text-lg text-gray-300">प्रक्रिया शुरू हो रही है...</p>
            </div>

            <!-- Results State -->
            <div id="results-container" class="hidden fade-in w-full">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                     <h2 class="text-3xl font-bold text-left">आपके परिणाम</h2>
                     <button id="download-all" class="btn btn-primary w-full sm:w-auto"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg><span>सभी डाउनलोड करें</span></button>
                 </div>
                <div id="search-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                <button id="reset-search-results" class="btn btn-secondary mt-8 mx-auto">नई खोज शुरू करें</button>
            </div>
            
            <!-- Not Found State -->
            <div id="not-found-container" class="hidden text-center p-8 step-card fade-in">
                 <h2 class="text-2xl font-bold text-green-400 mb-4">अभी नहीं, पर जल्द ही!</h2>
                 <p class="text-gray-300 mb-2">फिलहाल आपकी कोई तस्वीर हमारे संग्रह में नहीं मिली है।</p>
                 <p class="text-gray-400">हमने आपका चेहरा और ईमेल <b id="user-email-confirm" class="text-white"></b> सुरक्षित रूप से सहेज लिया है। जैसे ही आपकी कोई तस्वीर अपलोड होगी, हम आपको सूचित करेंगे।</p>
                 <button id="reset-search-notfound" class="btn btn-secondary mt-8">नई खोज शुरू करें</button>
            </div>
        </div>
    </main>

    <footer class="w-full max-w-5xl mx-auto py-4 text-center text-gray-500 text-sm">
        <p>&copy; 2025 [आपके क्लाइंट का नाम] | सर्वाधिकार सुरक्षित</p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-5 right-5 bg-red-600 text-white py-2 px-4 rounded-lg shadow-lg transition-transform duration-300 transform translate-x-full">
        <p id="toast-message"></p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "https://bnc6d104j2.execute-api.ap-southeast-1.amazonaws.com/prod/search";
        const S3_BUCKET_URL = "https://abstudios-photoapp-820345.s3.ap-southeast-1.amazonaws.com";
        // ---------------------

        // DOM Elements
        const mainContent = document.getElementById('main-content');
        const loaderContainer = document.getElementById('loader-container');
        const resultsContainer = document.getElementById('results-container');
        const notFoundContainer = document.getElementById('not-found-container');
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('snapshot-canvas');
        const context = canvas.getContext('2d');
        const startCameraBtn = document.getElementById('start-camera');
        const snapPhotoBtn = document.getElementById('snap-photo');
        const retryPhotoBtn = document.getElementById('retry-photo');
        const uploadFile = document.getElementById('upload-file');
        const searchResults = document.getElementById('search-results');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const controls = document.getElementById('controls');
        const liveControls = document.getElementById('live-controls');
        const userNameInput = document.getElementById('user-name');
        const userMobileInput = document.getElementById('user-mobile');
        const userEmailInput = document.getElementById('user-email');
        const userEmailConfirm = document.getElementById('user-email-confirm');
        const nameError = document.getElementById('name-error');
        const mobileError = document.getElementById('mobile-error');
        const emailError = document.getElementById('email-error');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const resetResultsBtn = document.getElementById('reset-search-results');
        const resetNotFoundBtn = document.getElementById('reset-search-notfound');

        const MAX_WIDTH = 800;

        function showToast(message, isError = true) {
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-transform duration-300 transform ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.remove('hidden', 'translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function validateInputs() {
            let isValid = true;
            if (userNameInput.value.trim() === '') { nameError.classList.remove('hidden'); isValid = false; } else { nameError.classList.add('hidden'); }
            if (userMobileInput.value.trim().length !== 10 || !/^\d{10}$/.test(userMobileInput.value.trim())) { mobileError.classList.remove('hidden'); isValid = false; } else { mobileError.classList.add('hidden'); }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(userEmailInput.value.trim())) { emailError.classList.remove('hidden'); isValid = false; } else { emailError.classList.add('hidden'); }
            
            if (!isValid) {
                if (userNameInput.value.trim() === '') userNameInput.focus();
                else if (userMobileInput.value.trim().length !== 10) userMobileInput.focus();
                else userEmailInput.focus();
            }
            return isValid;
        }

        startCameraBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                canvas.classList.add('hidden');
                controls.classList.add('hidden');
                liveControls.classList.remove('hidden');
            } catch (err) { showToast("कैमरा एक्सेस नहीं हो सका। कृपया अनुमति दें।"); }
        });

        const processImage = (imageSource, callback) => {
            const img = new Image();
            img.onload = () => {
                const aspectRatio = img.width / img.height;
                canvas.width = MAX_WIDTH;
                canvas.height = MAX_WIDTH / aspectRatio;
                context.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.classList.remove('hidden');
                video.classList.add('hidden');
                uploadPlaceholder.classList.add('hidden');
                liveControls.classList.remove('hidden');
                snapPhotoBtn.classList.add('hidden');
                if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                callback(imageData);
            };
            img.src = imageSource;
        };

        snapPhotoBtn.addEventListener('click', () => {
            if (!validateInputs()) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            processImage(tempCanvas.toDataURL(), (imageData) => {
                findMyPhotos(imageData, userNameInput.value, userMobileInput.value, userEmailInput.value);
            });
        });
        
        retryPhotoBtn.addEventListener('click', () => {
            video.classList.add('hidden');
            canvas.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            liveControls.classList.add('hidden');
            controls.classList.remove('hidden');
            startCameraBtn.click();
        });

        uploadFile.addEventListener('change', (event) => {
            if (!validateInputs()) { event.target.value = ''; return; }
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processImage(e.target.result, (imageData) => {
                    findMyPhotos(imageData, userNameInput.value, userMobileInput.value, userEmailInput.value);
                });
                reader.readAsDataURL(file);
            }
        });

        async function findMyPhotos(imageDataBase64, name, mobile, email) {
            mainContent.classList.add('hidden');
            loaderContainer.classList.remove('hidden');
            
            const loaderText = document.getElementById('loader-text');
            loaderText.textContent = "आपकी तस्वीर का विश्लेषण किया जा रहा है...";
            
            try {
                const base64Data = imageDataBase64.split(',')[1];

                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                      'Content-Type': 'text/plain'
                    },
                    body: base64Data
                });
                
                loaderText.textContent = "परिणाम तैयार किए जा रहे हैं...";

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API से जवाब नहीं मिला (HTTP ${response.status}). सर्वर लॉग्स जांचें।`);
                }

                const matches = await response.json();
                
                loaderContainer.classList.add('hidden');

                if (matches.length > 0) {
                    searchResults.innerHTML = '';
                    matches.forEach(match => {
                        const imageUrl = `${S3_BUCKET_URL}/${match.externalImageId}`;
                        const item = document.createElement('div');
                        item.className = 'image-result-item';
                        item.innerHTML = `
                            <img src="${imageUrl}" class="w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105">
                            <div class="download-overlay p-2 flex justify-end">
                                <a href="${imageUrl}" download target="_blank" class="p-2 bg-white/20 rounded-full hover:bg-white/40 transition-colors">
                                    <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </a>
                            </div>`;
                        searchResults.appendChild(item);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    userEmailConfirm.textContent = email;
                    notFoundContainer.classList.remove('hidden');
                }

            } catch(error) {
                console.error("Full API Call Error:", error);
                loaderContainer.classList.add('hidden');
                if (error.message.includes('Failed to fetch') || error.message.includes('ERR_NAME_NOT_RESOLVED')) {
                     showToast("API से कनेक्ट नहीं हो सका। कृपया सुनिश्चित करें कि API Gateway डिप्लॉय है।");
                } else {
                    showToast(`एक त्रुटि हुई: ${error.message}`);
                }
                resetApp();
            }
        }

        function resetApp() {
            resultsContainer.classList.add('hidden');
            notFoundContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            userNameInput.value = '';
            userMobileInput.value = '';
            userEmailInput.value = '';
            video.classList.add('hidden');
            canvas.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            liveControls.classList.add('hidden');
            controls.classList.remove('hidden');
            if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
        }

        resetResultsBtn.addEventListener('click', resetApp);
        resetNotFoundBtn.addEventListener('click', resetApp);
    </script>
</body>
</html>

