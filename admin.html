<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Event Memory Experience</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üì∏</text></svg>">
  <!-- Tailwind (CDN) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://esm.sh" crossorigin>
  <link rel="preconnect" href="https://esm.run" crossorigin>
  <link rel="preconnect" href="https://cdn.skypack.dev" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    .toast { position: fixed; right: 1rem; top: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem; background: #111827; color: #fff; opacity: 0; transition: opacity .2s ease, transform .2s ease; transform: translateY(-8px); z-index: 50; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #065f46; }
    .toast.error { background: #991b1b; }
    .toast.info { background: #1f2937; }
    .kbd {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 2px 6px; border: 1px solid #e5e7eb; border-bottom-width: 3px; border-radius: .5rem; background:#f9fafb}
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Toast container -->
  <div id="toast-container" class="toast" role="status" aria-live="polite"></div>

  <!-- Root container -->
  <div class="w-full max-w-5xl mx-auto p-4 sm:p-6 lg:p-8" data-admin-root>
    <!-- Header -->
    <header class="flex items-center justify-between pb-4 border-b border-gray-200">
      <h1 class="text-2xl font-semibold tracking-tight">‡§á‡§µ‡•á‡§Ç‡§ü ‡§ó‡•à‡§≤‡§∞‡•Ä ‡§è‡§°‡§Æ‡§ø‡§®</h1>
      <div class="flex items-center gap-2">
        <button id="diagBtn" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§°‡§æ‡§Ø‡§ó‡•ç‡§®‡•ã‡§∏‡•ç‡§ü‡§ø‡§ï‡•ç‡§∏</button>
        <button id="logoutBtn" class="hidden px-3 py-2 rounded-xl bg-gray-900 text-white text-sm hover:bg-black">‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü</button>
      </div>
    </header>

    <!-- Diagnostics panel -->
    <details id="diagPanel" class="mt-4">
      <summary class="cursor-pointer text-sm text-gray-600">Self‚Äëtests ‡§î‡§∞ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï/‡§ï‡§®‡•ç‡§´‡§º‡§ø‡§ó ‡§°‡§æ‡§Ø‡§ó‡•ç‡§®‡•ã‡§∏‡•ç‡§ü‡§ø‡§ï‡•ç‡§∏</summary>
      <div id="diagOut" class="mt-3 text-sm bg-white rounded-2xl shadow p-4 whitespace-pre-wrap"></div>
      <div class="mt-2 text-xs text-gray-500">‡§®‡•ã‡§ü: ‡§Ö‡§ó‡§∞ ‡§Ü‡§™ <span class="kbd">file://</span> ‡§∏‡•á ‡§ö‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§ï‡•Å‡§õ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•Ä‡§Æ‡§æ‡§è‡§Å ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡§Ç‡•§ ‡§¨‡•á‡§π‡§§‡§∞ ‡§π‡•à ‡§ï‡§ø <span class="kbd">http://localhost</span> ‡§™‡§∞ ‡§∏‡§∞‡•ç‡§µ ‡§ï‡§∞‡•á‡§Ç‡•§</div>
    </details>

    <!-- Login Section -->
    <section id="loginSection" class="admin-section active">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-4">‡§≤‡•â‡§ó‡§ø‡§®</h2>
          <div class="grid gap-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤</label>
            <input id="email" type="email" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com" />
            <label class="text-sm mt-2">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
            <input id="password" type="password" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <button id="loginBtn" class="mt-4 px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§≤‡•â‡§ó‡§ø‡§®</button>
            <button id="goToSignUp" class="mt-2 text-sm text-gray-700 underline">‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å</button>
            <p class="text-xs text-gray-500">‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç: ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•á ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§™‡•Ç‡§≤ ‡§Æ‡•á‡§Ç ‡§à‡§Æ‡•á‡§≤ ‡§∏‡§æ‡§á‡§®‚Äë‡§á‡§® ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§Ø‡§π ‡§´‡§º‡•Ä‡§≤‡•ç‡§° <em>‡§Ø‡•Ç‡§ú‡§º‡§∞‡§®‡•á‡§Æ</em> ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§ó‡§æ‡•§</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Sign Up Section -->
    <section id="signUpSection" class="admin-section">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-4">‡§∏‡§æ‡§á‡§®‚Äë‡§Ö‡§™</h2>
          <div class="grid gap-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤</label>
            <input id="suEmail" type="email" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com" />
            <label class="text-sm mt-2">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
            <input id="suPassword" type="password" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 8 ‡§ï‡•à‡§∞‡•á‡§ï‡•ç‡§ü‡§∞‡•ç‡§∏" />
            <button id="signUpBtn" class="mt-4 px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Å</button>
            <button id="backToLoginFromSignUp" class="mt-2 text-sm text-gray-700 underline">‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Confirm Section -->
    <section id="confirmSection" class="admin-section">
      <div class="grid gap-6 max-w-md mt-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-medium mb-2">‡§à‡§Æ‡•á‡§≤ ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®</h2>
          <p class="text-sm text-gray-600">‡§π‡§Æ‡§®‡•á ‡§Ü‡§™‡§ï‡•á ‡§à‡§Æ‡•á‡§≤ ‡§™‡§∞ ‡§è‡§ï ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡•Ä‡§ö‡•á ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§</p>
          <div class="grid gap-3 mt-3">
            <label class="text-sm">‡§à‡§Æ‡•á‡§≤</label>
            <input id="cfEmail" type="email" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="you@example.com" />
            <label class="text-sm mt-2">‡§ï‡•ã‡§°</label>
            <input id="cfCode" type="text" class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900" placeholder="123456" />
            <div class="flex gap-2 mt-2">
              <button id="confirmBtn" class="px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">‡§ï‡§®‡•ç‡§´‡§º‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç</button>
              <button id="resendBtn" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§ï‡•ã‡§° ‡§´‡§ø‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç</button>
              <button id="backToLoginFromConfirm" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100">‡§≤‡•â‡§ó‡§ø‡§®</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboardSection" class="admin-section">
      <div class="mt-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">‡§á‡§µ‡•á‡§Ç‡§ü‡•ç‡§∏</h2>
          <button id="refreshEvents" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂</button>
        </div>
        <div id="eventList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>
    </section>

    <!-- Upload Section -->
    <section id="uploadSection" class="admin-section">
      <div class="mt-8 bg-white rounded-2xl shadow p-6">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-lg font-medium">‡§´‡§º‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°</h2>
            <p id="uploadTitle" class="text-sm text-gray-500 mt-1">‡§ï‡§ø‡§∏‡•Ä ‡§á‡§µ‡•á‡§Ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§º‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç</p>
          </div>
          <button id="backToDashboard" class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm">‡§¨‡•à‡§ï</button>
        </div>
        <div class="mt-4 grid gap-3">
          <input id="fileInput" type="file" multiple accept="image/*" class="block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gray-900 file:text-white hover:file:bg-black" />
          <button id="startUpload" class="px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black disabled:opacity-50" disabled>‡§Ö‡§™‡§≤‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
          <div id="uploadStatus" class="text-sm text-gray-600"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Multi‚ÄëCDN Amplify loader + App -->
  <script>
    (function(){
      // ===== Config (editable) =====
      const DEFAULT_COGNITO = {
        REGION: 'ap-southeast-1',
        USER_POOL_ID: 'ap-southeast-1_YGZSUnSf5',
        USER_POOL_WEB_CLIENT_ID: '1mecg9v8gfau80k08arpofgl4l'
      };
      // URL overrides for quick testing: ?region=ap-south-1&userPoolId=xxx&clientId=yyy
      const qp = new URLSearchParams(location.search);
      const COGNITO = {
        REGION: qp.get('region') || DEFAULT_COGNITO.REGION,
        USER_POOL_ID: qp.get('userPoolId') || DEFAULT_COGNITO.USER_POOL_ID,
        USER_POOL_WEB_CLIENT_ID: qp.get('clientId') || DEFAULT_COGNITO.USER_POOL_WEB_CLIENT_ID,
      };
      const inferredRegion = (COGNITO.USER_POOL_ID.match(/^([a-z]{2}-[a-z-]+-\d+)_/i) || [null, null])[1];
      if (inferredRegion && inferredRegion !== COGNITO.REGION) {
        console.warn('[Amplify] Region mismatch: config', COGNITO.REGION, 'vs inferred from pool', inferredRegion, '‚Üí using inferred');
        COGNITO.REGION = inferredRegion;
      }

      // ===== Utilities =====
      function showToast(msg, type = 'info', ms = 3500) {
        const el = document.getElementById('toast-container');
        if (!el) return;
        el.className = 'toast ' + type;
        el.textContent = msg;
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => el.classList.remove('show'), ms);
      }
      const isFileProto = location.protocol === 'file:';

      // Sections
      const sectionIds = ['loginSection', 'signUpSection', 'confirmSection', 'dashboardSection', 'uploadSection'];
      function showSection(el) {
        sectionIds.forEach(id => document.getElementById(id).classList.remove('active'));
        el.classList.add('active');
      }

      // DOM nodes
      const loginSection = document.getElementById('loginSection');
      const dashboardSection = document.getElementById('dashboardSection');
      const signUpSection = document.getElementById('signUpSection');
      const confirmSection = document.getElementById('confirmSection');
      const uploadSection = document.getElementById('uploadSection');

      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const loginBtn = document.getElementById('loginBtn');
      const goToSignUp = document.getElementById('goToSignUp');

      const suEmail = document.getElementById('suEmail');
      const suPassword = document.getElementById('suPassword');
      const signUpBtn = document.getElementById('signUpBtn');
      const backToLoginFromSignUp = document.getElementById('backToLoginFromSignUp');

      const cfEmail = document.getElementById('cfEmail');
      const cfCode = document.getElementById('cfCode');
      const confirmBtn = document.getElementById('confirmBtn');
      const resendBtn = document.getElementById('resendBtn');
      const backToLoginFromConfirm = document.getElementById('backToLoginFromConfirm');

      const logoutBtn = document.getElementById('logoutBtn');
      const diagBtn = document.getElementById('diagBtn');
      const diagOut = document.getElementById('diagOut');

      const eventList = document.getElementById('eventList');
      const refreshEvents = document.getElementById('refreshEvents');

      const backToDashboard = document.getElementById('backToDashboard');
      const fileInput = document.getElementById('fileInput');
      const startUpload = document.getElementById('startUpload');
      const uploadTitle = document.getElementById('uploadTitle');
      const uploadStatus = document.getElementById('uploadStatus');

      // Enter-to-submit
      [emailInput, passwordInput].forEach(inp => inp && inp.addEventListener('keydown', e => { if (e.key === 'Enter') loginBtn.click(); }));

      // ===== Amplify Loader (UMD + ESM + timeouts) =====
      const fallbackAttemptLog = [];
      const AMPLIFY_URLS_UMD = [
        'https://cdn.jsdelivr.net/npm/aws-amplify@5.3.21/dist/aws-amplify.min.js',
        'https://cdn.jsdelivr.net/npm/aws-amplify@5/dist/aws-amplify.min.js',
        'https://cdn.jsdelivr.net/npm/aws-amplify/dist/aws-amplify.min.js',
        'https://unpkg.com/aws-amplify@5.3.21/dist/aws-amplify.min.js',
        'https://unpkg.com/aws-amplify@5/dist/aws-amplify.min.js',
        'https://unpkg.com/aws-amplify/dist/aws-amplify.min.js',
        '/libs/aws-amplify-5.min.js',
        '/vendor/aws-amplify.min.js'
      ];
      const AMPLIFY_URLS_ESM = [
        'https://cdn.skypack.dev/aws-amplify@5',
        'https://esm.run/aws-amplify@5',
        'https://esm.sh/aws-amplify@5?bundle',
        'https://esm.sh/aws-amplify@5.3.21?bundle'
      ];
      function withTimeout(promise, ms, label){
        let t; const err = new Error('Timeout: '+label); const timer = new Promise((_, reject)=> t = setTimeout(()=>reject(err), ms));
        return Promise.race([promise.finally(()=>clearTimeout(t)), timer]);
      }
      function scriptLoad(url){
        return new Promise((resolve, reject)=>{
          const s = document.createElement('script'); s.src = url; s.async = false;
          s.onload = () => { fallbackAttemptLog.push(`UMD ok: ${url}`); resolve(url); };
          s.onerror = () => { fallbackAttemptLog.push(`UMD fail: ${url}`); reject(new Error('Failed to load: '+url)); };
          document.head.appendChild(s);
        });
      }
      function moduleImport(url){
        return new Promise((resolve, reject)=>{
          const s = document.createElement('script'); s.type = 'module';
          s.textContent = `import * as pkg from '${url}'; window.aws_amplify = window.aws_amplify || pkg;`;
          s.onload = () => { fallbackAttemptLog.push(`ESM ok: ${url}`); resolve(url); };
          s.onerror = () => { fallbackAttemptLog.push(`ESM fail: ${url}`); reject(new Error('Failed to import: '+url)); };
          document.head.appendChild(s);
        });
      }
      async function ensureAmplify(){
        if (window.aws_amplify || window.AwsAmplify || window.Amplify || window.amplify) return true;
        let lastErr;
        for (const url of AMPLIFY_URLS_UMD){ try{ await withTimeout(scriptLoad(url), 4000, url); if (window.aws_amplify || window.AwsAmplify || window.Amplify || window.amplify) return true; }catch(e){ lastErr = e; } }
        for (const url of AMPLIFY_URLS_ESM){ try{ await withTimeout(moduleImport(url), 6000, url); if (window.aws_amplify || window.AwsAmplify || window.Amplify || window.amplify) return true; }catch(e){ lastErr = e; } }
        throw (lastErr || new Error('Amplify UMD not loaded'));
      }
      function resolveAmplify(){
        const ns = window.aws_amplify || window.AwsAmplify || window.Amplify || window.amplify;
        const Amplify = ns?.Amplify || ns?.default || ns; const Auth = ns?.Auth || Amplify?.Auth; const Storage = ns?.Storage || Amplify?.Storage; return { Amplify, Auth, Storage };
      }

      // ===== App Logic =====
      async function configureAmplify(){
        const { Amplify } = resolveAmplify();
        if (!Amplify?.configure) throw new Error('Amplify.configure not available');
        Amplify.configure({ Auth: { region: COGNITO.REGION, userPoolId: COGNITO.USER_POOL_ID, userPoolWebClientId: COGNITO.USER_POOL_WEB_CLIENT_ID, authenticationFlowType: 'USER_SRP_AUTH' } });
      }
      async function checkUserSession(){
        const { Auth } = resolveAmplify();
        try{ const user = await Auth.currentAuthenticatedUser(); if (user){ logoutBtn.classList.remove('hidden'); showSection(dashboardSection); await loadEvents(); } else { showSection(loginSection); } }
        catch{ showSection(loginSection); }
      }
      async function doLogin(){
        const { Auth } = resolveAmplify(); const username = emailInput.value.trim(); const password = passwordInput.value; if (!username || !password){ showToast('‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; }
        loginBtn.disabled = true;
        try{ const res = await Auth.signIn(username, password); showToast('‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§´‡§≤', 'success'); logoutBtn.classList.remove('hidden'); emailInput.value=''; passwordInput.value=''; showSection(dashboardSection); await loadEvents(); console.debug('SignIn result:', res); }
        catch(error){ console.error('SignIn error', error); const map={UserNotFoundException:'‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ ‚Äî ‡§™‡§π‡§≤‡•á ‡§∏‡§æ‡§á‡§®‚Äë‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§™‡•Ç‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç',NotAuthorizedException:'‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Ø‡§æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø',UserNotConfirmedException:'‡§à‡§Æ‡•á‡§≤ ‡§µ‡•á‡§∞‡§ø‡§´‡§º‡§ø‡§ï‡•á‡§∂‡§® ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó ‚Äî ‡§ï‡•ã‡§° ‡§ï‡§®‡•ç‡§´‡§º‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç',PasswordResetRequiredException:'‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï'}; const hint = map[error?.name] || (error?.message || '‡§≤‡•â‡§ó‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø'); showToast(`${error?.name ? error.name+': ' : ''}${hint}`, 'error', 6000); if (error?.name==='UserNotFoundException'){ suEmail.value=username; showSection(signUpSection);} if (error?.name==='UserNotConfirmedException'){ cfEmail.value=username; showSection(confirmSection);} }
        finally{ loginBtn.disabled = false; }
      }
      async function doSignUp(){
        const { Auth } = resolveAmplify(); const email = suEmail.value.trim(); const pwd = suPassword.value; if(!email||!pwd){ showToast('‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; }
        signUpBtn.disabled=true; try{ await Auth.signUp({ username: email, password: pwd, attributes:{ email } }); showToast('‡§∏‡§æ‡§á‡§®‚Äë‡§Ö‡§™ ‡§∏‡§´‡§≤ ‚Äî ‡§à‡§Æ‡•á‡§≤ ‡§™‡§∞ ‡§ï‡•ã‡§° ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ', 'success', 5000); cfEmail.value=email; cfCode.value=''; showSection(confirmSection);} catch(e){ console.error('SignUp error', e); showToast(e?.message || '‡§∏‡§æ‡§á‡§®‚Äë‡§Ö‡§™ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } finally{ signUpBtn.disabled=false; }
      }
      async function doConfirm(){
        const { Auth } = resolveAmplify(); const email=(cfEmail.value||'').trim(); const code=(cfCode.value||'').trim(); if(!email||!code){ showToast('‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§ï‡•ã‡§° ‡§≠‡§∞‡•á‡§Ç', 'error'); return; }
        confirmBtn.disabled=true; try{ await Auth.confirmSignUp(email, code); showToast('‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§∏‡§´‡§≤ ‚Äî ‡§Ö‡§¨ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç', 'success'); emailInput.value=email; showSection(loginSection);} catch(e){ console.error('Confirm error', e); showToast(e?.message || '‡§ï‡§®‡•ç‡§´‡§º‡§∞‡•ç‡§Æ‡•á‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } finally{ confirmBtn.disabled=false; }
      }
      async function doResend(){ const { Auth } = resolveAmplify(); const email=(cfEmail.value||'').trim(); if(!email){ showToast('‡§à‡§Æ‡•á‡§≤ ‡§≠‡§∞‡•á‡§Ç', 'error'); return; } try{ await Auth.resendSignUp(email); showToast('‡§ï‡•ã‡§° ‡§™‡•Å‡§®‡§É ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ', 'success'); } catch(e){ console.error('Resend error', e); showToast(e?.message || '‡§∞‡•Ä‚Äë‡§∏‡•á‡§Ç‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error'); } }
      async function doLogout(){ const { Auth } = resolveAmplify(); try{ await Auth.signOut(); }catch{} showToast('‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 'info'); logoutBtn.classList.add('hidden'); showSection(loginSection); }

      // Dummy events
      async function loadEvents(){ const items=[{id:'evt_1',name:'Diwali Night 2024',photos:0},{id:'evt_2',name:'Wedding - A&V',photos:120},{id:'evt_3',name:'Corporate Meetup',photos:58}]; renderEvents(items); }
      function renderEvents(items){ eventList.innerHTML=''; if(!items||!items.length){ eventList.innerHTML='<div class="text-sm text-gray-600">‡§ï‡•ã‡§à ‡§á‡§µ‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</div>'; return; } for(const it of items){ const card=document.createElement('div'); card.className='bg-white rounded-2xl shadow p-5 flex flex-col gap-3'; card.innerHTML=`<div class="flex-1"><div class="text-base font-semibold">${it.name}</div><div class="text-sm text-gray-500 mt-1">‡§´‡§º‡•ã‡§ü‡•ã: ${it.photos}</div></div><div class="flex gap-2"><button class="upload-btn px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-black text-sm" data-event-id="${it.id}" data-event-name="${it.name}">‡§´‡§º‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°</button><button class="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm" disabled>‡§Æ‡•à‡§®‡•á‡§ú</button></div>`; eventList.appendChild(card);} }

      // Delegation & Upload
      eventList.addEventListener('click', (e)=>{ const btn=e.target.closest('.upload-btn'); if(!btn) return; const eventName=btn.dataset.eventName; const eventId=btn.dataset.eventId; uploadTitle.textContent=`"${eventName}" ‡§Æ‡•á‡§Ç ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç`; uploadSection.dataset.eventId=eventId; showSection(uploadSection); });
      fileInput.addEventListener('change', ()=>{ startUpload.disabled=!(fileInput.files&&fileInput.files.length); uploadStatus.textContent=''; });
      async function uploadFilesForEvent(eventId){ if(!fileInput.files?.length) return; const files=Array.from(fileInput.files); let uploaded=0; for(const file of files){ try{ await new Promise(r=>setTimeout(r,300)); uploaded++; uploadStatus.textContent=`${uploaded}/${files.length} ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ`; } catch(e){ console.error('Upload failed', e); showToast('‡§ï‡§ø‡§∏‡•Ä ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§µ‡§ø‡§´‡§≤', 'error'); } } if(uploaded===files.length){ showToast('‡§∏‡§≠‡•Ä ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à‡§Ç', 'success'); fileInput.value=''; startUpload.disabled=true; } }

      // Handlers
      loginBtn.addEventListener('click', doLogin);
      goToSignUp.addEventListener('click', ()=> showSection(signUpSection));
      signUpBtn.addEventListener('click', doSignUp);
      backToLoginFromSignUp.addEventListener('click', ()=> showSection(loginSection));
      confirmBtn.addEventListener('click', doConfirm);
      resendBtn.addEventListener('click', doResend);
      backToLoginFromConfirm.addEventListener('click', ()=> showSection(loginSection));
      logoutBtn.addEventListener('click', doLogout);
      refreshEvents.addEventListener('click', loadEvents);
      backToDashboard.addEventListener('click', ()=> showSection(dashboardSection));
      startUpload.addEventListener('click', async()=>{ const eventId=uploadSection.dataset.eventId; if(!eventId){ showToast('‡§á‡§µ‡•á‡§Ç‡§ü ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç', 'error'); return; } await uploadFilesForEvent(eventId); });

      diagBtn.addEventListener('click', runDiagnostics);

      // Boot
      (async function boot(){ try{ if(isFileProto) showToast('‡§¨‡•á‡§π‡§§‡§∞ ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§π‡•á‡§§‡•Å localhost ‡§∏‡•á ‡§ö‡§≤‡§æ‡§è‡§Å', 'info', 4500); showToast('Amplify ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶', 'info'); await ensureAmplify(); const { Amplify, Auth } = resolveAmplify(); if(!Amplify||!Auth) throw new Error('Amplify globals missing after load'); await configureAmplify(); showToast('Amplify ‡§§‡•à‡§Ø‡§æ‡§∞', 'success'); await checkUserSession(); } catch(e){ console.error(e); showToast('Amplify ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‚Äî ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï/CDN ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç', 'error'); showSection(loginSection); } })();

      // Tests
      function logDiag(line){ diagOut.textContent += (line + '\n'); }
      function clearDiag(){ diagOut.textContent = ''; }
      function assertTest(name, cond){ logDiag(`${cond ? '‚úÖ' : '‚ùå'} ${name}`); return !!cond; }
      async function runDiagnostics(){
        clearDiag(); logDiag('‚Äî ‡§∞‡§®‡§ø‡§Ç‡§ó Self‚Äëtests ‚Äî'); logDiag(`URL: ${location.href}`); logDiag(`Protocol: ${location.protocol}`);
        logDiag('Config (final):'); logDiag('  REGION=' + COGNITO.REGION); logDiag('  USER_POOL_ID=' + COGNITO.USER_POOL_ID); logDiag('  CLIENT_ID=' + COGNITO.USER_POOL_WEB_CLIENT_ID); logDiag('  Inferred from pool=' + (inferredRegion || 'n/a')); logDiag('  Expected Cognito endpoint: https://cognito-idp.'+COGNITO.REGION+'.amazonaws.com');
        if (fallbackAttemptLog.length){ logDiag('Loader attempts:'); fallbackAttemptLog.forEach(x=>logDiag('  ‚Ä¢ '+x)); } else { logDiag('Loader attempts: (none recorded ‚Äî library may be cached/present)'); }
        let ampNS = window.aws_amplify || window.AwsAmplify || window.Amplify || window.amplify; assertTest('Amplify namespace detected', !!ampNS);
        const { Amplify, Auth } = resolveAmplify(); assertTest('Amplify.configure ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', !!Amplify?.configure); assertTest('Auth.signIn ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', typeof Auth?.signIn === 'function'); assertTest('Auth.signUp ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', typeof Auth?.signUp === 'function'); assertTest('Auth.confirmSignUp ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', typeof Auth?.confirmSignUp === 'function'); assertTest('Auth.currentAuthenticatedUser ‡§â‡§™‡§≤‡§¨‡•ç‡§ß', typeof Auth?.currentAuthenticatedUser === 'function');
        const before = document.querySelector('.admin-section.active'); showSection(dashboardSection); const dashActive = dashboardSection.classList.contains('active'); assertTest('Dashboard ‡§¶‡§ø‡§ñ ‡§∞‡§π‡§æ ‡§π‡•à', dashActive); showSection(before || loginSection);
        renderEvents([{id:'t_evt', name:'Test Event', photos: 1}]); const btn = document.querySelector('.upload-btn'); const hadBtn = assertTest('Upload ‡§¨‡§ü‡§® ‡§Æ‡•å‡§ú‡•Ç‡§¶', !!btn); if (hadBtn){ btn.click(); const upActive = uploadSection.classList.contains('active'); assertTest('Upload ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ñ‡•Å‡§≤‡§§‡§æ ‡§π‡•à', upActive); backToDashboard.click(); }
        assertTest('Start Upload disabled by default', startUpload.disabled === true);
        assertTest('Region matches userPool prefix (auto-fixed)', !inferredRegion || inferredRegion === COGNITO.REGION);
        // New: sign-up navigation exposure (synthetic)
        (function(){ suEmail.value = 'test@example.com'; showSection(signUpSection); })(); const inSU = signUpSection.classList.contains('active'); assertTest('Sign‚Äëup ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§¶‡§ø‡§ñ‡§§‡§æ ‡§π‡•à (nav)', inSU); showSection(loginSection);
        try { await fetch('https://cdn.jsdelivr.net', { method:'HEAD', mode:'no-cors' }); logDiag('CDN reachability: attempted (no-cors)'); } catch(e){ logDiag('CDN reachability: blocked'); }
        logDiag('‚Äî Self‚Äëtests complete ‚Äî'); document.getElementById('diagPanel').open = true;
      }
    })();
  </script>
</body>
</html>
